# Vault PKI Demo - SSL Virtual Host Configuration
# This configuration serves HTTPS traffic with Vault-issued certificates

<VirtualHost *:443>
    ServerName {{ demo_domain }}
    ServerAlias {{ demo_hostname }}.{{ app_domain }}
    DocumentRoot {{ httpd_document_root }}
    
    # SSL Configuration
    SSLEngine on
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    
    # Vault-issued SSL Certificate
    SSLCertificateFile {{ httpd_ssl_dir }}/server.crt
    SSLCertificateKeyFile {{ httpd_ssl_dir }}/server.key
    
    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Custom headers for demo
    Header always set X-Vault-PKI-Demo "Phase2-AutoSSL"
    Header always set X-Certificate-Source "HashiCorp-Vault-PKI"
    
    # Logging
    CustomLog /var/log/httpd/vault-demo-ssl-access.log combined
    ErrorLog /var/log/httpd/vault-demo-ssl-error.log
    LogLevel info
    
    # Directory configuration
    <Directory "{{ httpd_document_root }}">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

# HTTP to HTTPS Redirect
<VirtualHost *:80>
    ServerName {{ demo_domain }}
    ServerAlias {{ demo_hostname }}.{{ app_domain }}
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
    
    # Custom header for demo
    Header always set X-Vault-PKI-Demo "Phase2-HTTPRedirect"
    
    # Logging
    CustomLog /var/log/httpd/vault-demo-redirect-access.log combined
    ErrorLog /var/log/httpd/vault-demo-redirect-error.log
</VirtualHost>
