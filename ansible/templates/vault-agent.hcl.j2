# Vault Agent Configuration for AWS EC2 Authentication
# Auto-login using EC2 instance metadata and manage SSL certificates

vault {
  address = "{{ vault_addr }}"
  {% if vault_namespace %}
  namespace = "{{ vault_namespace }}"
  {% endif %}
}

# AWS EC2 Auto-Authentication
auto_auth {
  method "aws" {
    mount_path = "auth/aws"
    config = {
      type = "ec2"
      role = "demo-role"
    }
  }

  sink "file" {
    config = {
      path = "{{ vault_agent_cache_dir }}/vault-token"
    }
  }
}

# Cache configuration for better performance
cache {
  use_auto_auth_token = true
}

# API proxy for local applications
listener "tcp" {
  address = "127.0.0.1:8200"
  tls_disable = true
}

# SSL Certificate Template - Auto-renewal
template {
  source      = "{{ vault_agent_config_dir }}/ssl-cert-template.hcl"
  destination = "{{ httpd_ssl_dir }}/server.crt"
  perms       = 0644
  command     = "/bin/systemctl reload httpd"
  
  # Wait configuration for certificate renewal
  wait {
    min = "10s"
    max = "30s"
  }
}

# SSL Private Key Template
template {
  contents = <<-EOT
{{ with secret "{{ vault_pki_path }}/issue/{{ vault_pki_role }}" 
  "common_name={{ demo_domain }}" 
  "alt_names={{ demo_hostname }}.{{ app_domain }}" 
  "ttl={{ cert_max_ttl_h }}h" }}
{{ .Data.private_key }}{{ end }}
EOT
  destination = "{{ httpd_ssl_dir }}/server.key"
  perms       = 0600
  command     = "/bin/systemctl reload httpd"
  
  wait {
    min = "10s"
    max = "30s"
  }
}
