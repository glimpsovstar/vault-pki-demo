# Vault PKI Demo - Phase 1: CLI Certificate Lifecycle

This phase demonstrates the complete PKI certificate lifecycle using Vault's CLI interface. It shows how certificates are issued, managed, renewed, and revoked using HashiCorp Vault's PKI secrets engine.

## Overview

Phase 1 covers the foundational PKI operations:
- Root CA verification (created via Terraform)
- Certificate issuance (both direct and CSR-based)
- Certificate inspection and validation
- Certificate renewal/re-issuance
- Certificate revocation
- Certificate Revocation List (CRL) management

## Prerequisites

Before running this demo, ensure you have:

1. **Required Tools:**
   - `vault` CLI (authenticated)
   - `jq` (JSON processor)
   - `terraform` (for infrastructure setup)
   - `openssl` (for certificate inspection)
   - `curl` (for HTTP requests)

2. **Infrastructure Setup:**
   ```bash
   cd terraform/
   terraform init
   terraform apply
   ```

3. **Vault Authentication:**
   The demo script automatically reads the Vault token from your Terraform configuration (`terraform.auto.tfvars`).

## Demo Steps

### Initial Setup - Token Verification
- **Purpose:** Verify authentication and token permissions
- **Key Highlights:**
  - Shows token TTL and expiration time
  - Displays policies assigned to the token
  - Confirms namespace and access level

### 1.1 Show PKI Mount (configured via Terraform)
- **Purpose:** Displays the PKI secrets engine mount and configuration
- **Key Highlights:**
  - PKI engine is properly mounted at the configured path
  - Max lease TTL settings (8760 hours = 1 year for CA)
  - Mount description shows it was created for this demo

### 1.2 Show Root CA Certificate (created via Terraform)
- **Purpose:** Displays the root Certificate Authority certificate and URLs
- **Key Highlights:**
  - Root CA certificate was automatically generated by Terraform
  - Certificate is valid for 1 year (as configured)
  - Issuing and CRL URLs are properly configured for certificate validation

### 1.3 Show PKI Role Configuration
- **Purpose:** Displays the PKI role settings for certificate issuance
- **Key Highlights:**
  - Allowed domains are restricted to your configured domain
  - Certificate TTL is limited (72 hours max)
  - Key type and size are specified (RSA 2048-bit)
  - Role enforces security best practices

### 1.4 Issue a Certificate
- **Purpose:** Issues a new certificate using Vault's simplified flow
- **Key Highlights:**
  - Vault generates both private key and certificate in one step
  - Certificate includes full chain (certificate + CA)
  - Serial number is automatically assigned
  - Certificate is stored in Vault for tracking
  - **Note:** Vault generates both CSR and certificate internally for this flow

### 1.5 Show Certificate Details and Expiration
- **Purpose:** Extracts and displays certificate information using OpenSSL
- **Key Highlights:**
  - Certificate serial number for tracking and revocation
  - Subject information matches requested CN
  - Expiration date confirms TTL setting
  - Certificate format is standard X.509

### 1.6 List Existing Certificates
- **Purpose:** Shows all certificates in the PKI store
- **Key Highlights:**
  - Both issued certificates and the root CA are listed
  - Serial numbers are shown for identification
  - Demonstrates certificate tracking capability

### 1.7 Verify Certificate Chain
- **Purpose:** Validates the certificate's issuer and chain of trust
- **Key Highlights:**
  - Issued certificate shows correct issuer (Demo Root CA)
  - Root CA subject matches the issuer field
  - Chain of trust is properly established
  - Certificate validation would succeed

### 1.8 Certificate Renewal (Re-issuance)
- **Purpose:** Issues a new certificate for the same Common Name (renewal process)
- **Key Highlights:**
  - Same CN can have multiple valid certificates
  - New certificate gets different serial number
  - Old certificate remains valid until revoked or expired
  - Demonstrates zero-downtime renewal capability

### 1.9 Show New Certificate Details
- **Purpose:** Displays details of the renewed certificate
- **Key Highlights:**
  - New serial number confirms this is a different certificate
  - Same subject but different validity period
  - Both certificates are now valid for the same CN

### 1.10 Check Revocation Status BEFORE Revoke
- **Purpose:** Shows certificate status before revocation
- **Key Highlights:**
  - `revocation_time` shows `0` (not revoked)
  - `revocation_time_rfc3339` shows `n/a` (clean state)
  - Certificate is currently valid and trusted

### 1.11 Revoke Certificate
- **Purpose:** Revokes the first certificate
- **Key Highlights:**
  - Revocation is immediate and irreversible
  - Revocation time is recorded (Unix timestamp)
  - Certificate is added to the CRL automatically
  - Demonstrates lifecycle management capability

### 1.12 Check Revocation Status AFTER Revoke
- **Purpose:** Shows certificate status after revocation
- **Key Highlights:**
  - `revocation_time` now shows Unix timestamp
  - `revocation_time_rfc3339` shows human-readable format
  - `state` field shows `revoked`
  - Certificate is now untrusted

### 1.13 Generate CSR and Sign with Vault (Optional)
- **Purpose:** Demonstrates traditional CSR-based certificate flow
- **Key Highlights:**
  - Shows manual private key generation with OpenSSL
  - CSR creation with specific subject information
  - Vault signs the CSR using the configured role
  - Demonstrates integration with existing PKI workflows
  - Private key never leaves the client system

### 1.14 Certificate Revocation List (CRL)
- **Purpose:** Displays the Certificate Revocation List with revoked certificates
- **Key Highlights:**
  - CRL is automatically maintained by Vault
  - Contains serial numbers of revoked certificates
  - Can be distributed to validate certificate status
  - Standard PEM format for compatibility

### 1.15 Cleanup
- **Purpose:** Removes temporary files created during the demo
- **Key Highlights:**
  - Good security practice to clean up sensitive files
  - Temporary certificates and keys are removed
  - Demo environment is returned to clean state

## Running the Demo

### Interactive Step-by-Step Demo (Recommended)

For the best learning experience, run the demo in interactive mode where you press Enter to proceed through each step:

```bash
# From the project root directory
cd /path/to/vault-pki-demo

# Interactive demo with realistic typing speed
PROMPT_TIMEOUT=30 TYPE_SPEED=20 ./scripts/demo-magic-vault-pki.sh
```

### Demo Mode Options

#### **1. Full Interactive Demo (Best for Learning)**
```bash
# Realistic typing speed, wait for Enter on each step
PROMPT_TIMEOUT=30 TYPE_SPEED=20 ./scripts/demo-magic-vault-pki.sh
```

#### **2. Fast Interactive Demo (Quick Testing)**
```bash
# Instant typing, still waits for Enter
PROMPT_TIMEOUT=30 TYPE_SPEED=0 ./scripts/demo-magic-vault-pki.sh
```

#### **3. Presentation Mode (Slow and Clear)**
```bash
# Slower typing for presentations, shorter wait
PROMPT_TIMEOUT=10 TYPE_SPEED=40 ./scripts/demo-magic-vault-pki.sh
```

#### **4. Automated Mode (No Interaction)**
```bash
# Runs continuously without prompts
TYPE_SPEED=0 ./scripts/demo-magic-vault-pki.sh
```

#### **5. Custom Certificate Demo**
```bash
# Custom certificate name and longer TTL
CN_BASE="myapp" TTL_DEMO="15m" PROMPT_TIMEOUT=30 ./scripts/demo-magic-vault-pki.sh
```

### Interactive Demo Experience

When running in interactive mode, the demo will:

- üñ•Ô∏è  **Clear the console** before each major step for better focus
- üéØ **Show clear section headers** with step numbers and descriptions  
- ‚å®Ô∏è  **Type each command** at the specified speed (realistic demo effect)
- ‚è∏Ô∏è  **Wait for your Enter key** before executing each command
- üìã **Display `[press Enter]`** prompt for each step
- üìä **Show a summary** of what you learned at the end

This allows you to:

- Explain each step to an audience
- Read and understand commands before they execute
- Control the pace of the demonstration
- Focus on one step at a time without distractions
- Present in a clean, professional manner

### Customization Options

You can customize the demo behavior with environment variables:

```bash
# Speed up the demo (no typing animation)
TYPE_SPEED=0 ./scripts/demo-magic-vault-pki.sh

# Customize certificate details
CN_BASE="myapp" DOMAIN_DEMO="example.com" TTL_DEMO="10m" ./scripts/demo-magic-vault-pki.sh

# Add confirmation prompts
PROMPT_TIMEOUT=5 ./scripts/demo-magic-vault-pki.sh
```

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `TYPE_SPEED` | `20` | Characters per second for typing animation (0 = instant) |
| `PROMPT_TIMEOUT` | `0` | Wait time for user confirmation (0 = no wait) |
| `CN_BASE` | `app` | Base name for certificate Common Name |
| `DOMAIN_DEMO` | From Terraform | Domain suffix for certificates |
| `TTL_DEMO` | `5m` | Certificate Time-To-Live |

## Expected Output

The demo will show:

1. **PKI Infrastructure:** Mount points, root CA, and role configurations
2. **Certificate Operations:** Issuance, inspection, and validation
3. **Certificate Lifecycle:** Renewal and revocation processes
4. **Security Features:** Certificate chains, CRL, and validation

## Key Learning Points

After running Phase 1, you will understand:

- ‚úÖ How Vault PKI secrets engine is configured
- ‚úÖ Root CA certificate structure and purpose
- ‚úÖ Certificate issuance methods (direct vs CSR-based)
- ‚úÖ Certificate inspection and validation techniques
- ‚úÖ Certificate renewal and lifecycle management
- ‚úÖ Certificate revocation and CRL management
- ‚úÖ Chain of trust validation

## Presentation Tips

### For Instructors/Presenters

When presenting this demo to an audience, focus on these **key teaching moments**:

#### **Step 1.1 - PKI Mount:**
- üéØ **Highlight:** "Notice the max_lease_ttl is 8760 hours - that's exactly 1 year, matching our Terraform configuration"
- üìù **Explain:** PKI mount is like a dedicated workspace for certificate operations

#### **Step 1.2 - Root CA:**
- üéØ **Highlight:** "This root certificate was automatically generated by Terraform - no manual certificate creation needed"
- üìù **Explain:** Root CA is the trust anchor for all issued certificates

#### **Step 1.4 - Certificate Issuance:**
- üéØ **Highlight:** "Watch how Vault returns both the certificate AND the private key in one operation"
- üìù **Explain:** This is different from traditional CA workflows where you generate keys separately

#### **Step 1.5 - Certificate Details:**
- üéØ **Highlight:** "The serial number is unique and will be used for revocation"
- üìù **Explain:** OpenSSL commands show this is a standard X.509 certificate

#### **Step 1.7 - Chain Verification:**
- üéØ **Highlight:** "The issuer of our certificate matches the subject of our Root CA"
- üìù **Explain:** This proves the chain of trust is properly established

#### **Step 1.8 - Renewal:**
- üéØ **Highlight:** "Notice we can issue multiple valid certificates for the same CN"
- üìù **Explain:** This enables zero-downtime certificate rotation

#### **Step 1.11-1.12 - Revocation:**
- üéØ **Highlight:** "Revocation is immediate and irreversible - watch the timestamp change"
- üìù **Explain:** Revoked certificates should never be trusted again

#### **Step 1.13 - CSR Flow:**
- üéØ **Highlight:** "This shows how Vault integrates with existing PKI workflows"
- üìù **Explain:** Private key never leaves the client system - better security

### Timing Recommendations

- **Full Demo:** 15-20 minutes with explanations
- **Quick Overview:** 8-10 minutes (focus on steps 1.4, 1.8, 1.11)
- **Deep Dive:** 30-45 minutes with Q&A

### Common Questions & Answers

**Q: How does this compare to traditional CA solutions?**
A: Vault automates many manual processes and provides API-driven certificate management

**Q: Can we use intermediate CAs?**
A: Yes! This demo shows a simple root CA, but Vault supports complex PKI hierarchies

**Q: How do applications consume these certificates?**
A: That's covered in Phase 2 - application integration and automation

**Q: What about certificate monitoring and alerting?**
A: Vault provides APIs and can integrate with monitoring systems for certificate expiration tracking

## Troubleshooting

### Common Issues

1. **"Missing dependency" error:**
   ```bash
   # Install missing tools
   brew install vault jq openssl
   ```

2. **"Terraform not initialized" error:**
   ```bash
   cd terraform/
   terraform init && terraform apply
   ```

3. **"Permission denied" errors:**
   - Verify your Vault token has sufficient permissions
   - Check that the Vault token in `terraform.auto.tfvars` is valid

4. **"No such file or directory" errors:**
   - Ensure you're running the script from the project root directory
   - Verify all required files are present

### Debug Mode

For troubleshooting, you can run the script with additional logging:
```bash
set -x  # Enable command tracing
./scripts/demo-magic-vault-pki.sh
```

## Next Steps

After completing Phase 1, you can:

1. **Proceed to Phase 2:** Application integration and automation
2. **Explore Advanced Features:** Intermediate CAs, certificate templates
3. **Production Considerations:** High availability, monitoring, and automation

## File Structure

```
vault-pki-demo/
‚îú‚îÄ‚îÄ Demo-Phase1.md                    # This documentation
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ demo-magic-vault-pki.sh      # Main demo script
‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ       ‚îî‚îÄ‚îÄ demo-magic.sh            # Demo utilities
‚îú‚îÄ‚îÄ terraform/                       # Infrastructure as Code
‚îÇ   ‚îú‚îÄ‚îÄ pki.tf                      # PKI configuration
‚îÇ   ‚îú‚îÄ‚îÄ auth_approle.tf             # Authentication setup
‚îÇ   ‚îú‚îÄ‚îÄ terraform.auto.tfvars       # Configuration variables
‚îÇ   ‚îî‚îÄ‚îÄ ...                         # Other Terraform files
‚îî‚îÄ‚îÄ README.md                        # Project overview
```

## Security Notes

‚ö†Ô∏è **Important:** This demo is designed for educational and demonstration purposes. For production use:

- Use proper secret management for Vault tokens
- Implement proper RBAC and policies
- Consider intermediate CA architectures
- Implement proper monitoring and alerting
- Follow your organization's security policies

---

**Happy Learning!** üéì This Phase 1 demo provides a comprehensive foundation for understanding Vault PKI operations.
